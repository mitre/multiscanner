{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="/static/css/fileinput.min.css">
<script src="/static/js/fileinput.min.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    $("#filesUpload").fileinput({
      uploadUrl: "http://{{ api_loc }}/api/v1/tasks/create/",
      browseOnZoneClick: true,
      allowedPreviewTypes: [],
      showUpload: false,
      browseLabel: "Select File(s) â€¦",
      removeLabel: "Clear",
      removeClass: "btn btn-danger",
      msgUploadEnd: "Submitted to scanner",
      previewTemplates: {
          other: '<div class="file-preview-frame krajee-default kv-preview-thumb foobar" id="{previewId}" data-fileindex="{fileindex}" data-template="{template}" title="{caption}">\n' +
          '   <div class="file-thumbnail-footer">\n' +
          '    <div class="file-preview-other">' +
          '    <span class="file-other-icon"><i class="glyphicon glyphicon-file"></i></span>' +
          '    </div>' +
          '        {footer}\n' +
          '    </div>\n' +
          '</div>\n' + 
          '<div class="collapse text-center metadata-group" data-target="{previewId}">\n' +
          {% for metadata in metadata_fields %}
          '<div class="form-group-sm">\n' +
          {% set field = metadata|replace(" ", "-")|replace(".", "-")|replace("#", "-")%}
          '    <label for="{previewId}-{{field}}" class="col-md-2 control-label">{{metadata}}</label>\n' +
          '    <div class="input-group col-md-10">\n' +
                  '<input type="text" class="form-control" id="{previewId}-{{field}}" name="{previewId}-{{field}}"></input>\n' +
          '    </div>\n' +
          '    </div>\n' +
          {% endfor %}
          '</div>\n',
      },
      layoutTemplates: {
        main1: '{preview}\n' +
          '<div class="kv-upload-progress hide"></div>\n' +
          '<div class="input-group {class}">\n' +
          '    {caption}\n' +
          '    <div class="input-group-btn">\n' +
          '        {remove}\n' +
          '        {cancel}\n' +
          '        {upload}\n' +
          '        {browse}\n' +
          '    </div>\n' +
          '</div>',
        actions: '<div class="file-actions">\n' +
          '    <div class="file-footer-buttons">\n' +
          '        {upload} {delete} {other}' +
          '        <button type="button" class="add-metadata btn btn-xs btn-default" title="Add metadata">\n' +
          '            <i class="glyphicon glyphicon-th-list"></i>\n' +
          '        </button>\n' + 
          '    </div>\n' +
          '    {drag}\n' +
          '    <div class="file-upload-indicator" title="{indicatorTitle}">{indicator}</div>\n' +
          '    <div class="clearfix"></div>\n' +
          '</div>',
        footer: '<div class="file-footer-caption" title="{caption}">{caption}<br>{size}</div>\n' +
          '        {progress} {actions}',
      },
      previewFileIcon: '',
      fileActionSettings: {
        removeIcon: '<i class="glyphicon glyphicon-trash"></i>',
        removeClass: 'btn btn-xs btn-danger',
        uploadIcon: '<i class="glyphicon glyphicon-upload"></i>',
        uploadClass: 'btn btn-xs btn-primary',
      },
      uploadExtraData: function (previewId, index) {
        // Send metadata along with the file
        var obj = {};
        $('.metadata-group[data-target=' + previewId + '] .form-group-sm').each(function() {
          var key = $(this).children('label').first().html();
          var val = $(this).find('input').first().val();
          obj[key] = val;
        });
        return obj;
      }
    });

    $("#filesUpload").on('fileuploaded', function(event, data, previewId, index) {
      // Hide buttons after upload
      $('#' + previewId + ' .file-footer-buttons').css('visibility', 'hidden');

      // Disable metadata fields after upload
      $('.metadata-group[data-target=' + previewId + '] input').each(function (index, element) {
        $(element).attr('readonly', true);
      })

      // Click on preview box to go straight to the task/report
      $('#' + previewId).css('cursor', 'pointer');
      $('#' + previewId).click(function() {
        window.location = "report/" + data.response.Message.task_id;
      })
    });

    $('#filesUpload').on('fileloaded', function(event, file, previewId, index, reader) {
      // Singularize/pluralize submit button text
      if ($("#filesUpload").fileinput('getFilesCount') > 1) {
        $('#btn-scan').html('Scan them!');
      } else {
        $('#btn-scan').html('Scan it!');
      }

      // Show/hide per file metadata input
      $('#' + previewId + ' .add-metadata').click(function() {
        $('.metadata-group[data-target=' + previewId + ']').collapse('toggle');
      });

      // Populate metadata fields if need be
      $('#adv-options .metadata-group input').each(function( index, element ) {
        var field = $(element).attr('id').substring(9);
        var value = $(element).val();
        $('#' + previewId + '-' + field).val(value);
      });
    });

    // Set metadata field values for all files
    $('#adv-options .metadata-group input').change(function() {
      var field = $(this).attr('id').substring(9);
      var value = $(this).val();
      $('.file-preview-thumbnails .metadata-group').each(function( index, element ) {
        childId = $(element).attr('data-target') + '-' + field;
        $(element).find('input[id=' + childId + ']').val(value);
      });
    });

    // Submit all files
    $('#btn-scan').click(function () {
      $("#filesUpload").fileinput('upload');
    });
  });
</script>
{% endblock %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="row alert-row">
  <div class="col-md-6 col-md-offset-6"></div>
</div>

<div class="row">
  <div class="col-md-8 col-md-offset-2">
    <h1 class="text-center">MultiScanner</h1>
    <br />

    <form class="form-horizontal" id="scan-form" enctype="multipart/form-data">
      <fieldset>
        <legend>Submit Files For Analysis</legend>

        <div class="form-group">
          <div class="input-group col-md-12" id="file-group">
            <input type="file" class='file-loading' id="filesUpload" name="file" multiple></input>
          </div>
        </div>

        <div class="form-group text-center">
          <button type="button" class="btn-sm btn-default" id="btn-opts" data-toggle="collapse" data-target="#adv-options" aria-expanded="false" aria-controls="adv-options">Advanced Options</button>
        </div>
        <div id="adv-options" class="collapse form-group text-center">
          <div><p><i>(These apply to all files in this submission.)</i></p></div>
          {% for metadata in metadata_fields %}
          <div class="form-group metadata-group">
          {% set field = metadata|replace(" ", "-")|replace(".", "-")|replace("#", "-")%}
          <label for="metadata-{{field}}" class="col-md-2 control-label">{{metadata}}</label>
          <div class="input-group col-md-10">
            <input type="text" class='form-control' id="metadata-{{field}}" name="metadata-{{field}}"></input>
          </div>
          </div>
          {% endfor %}
        </div>

        <div class="form-group text-center">
          <button type="button" class="btn-lg btn-success" id="btn-scan">Scan it!</button>
        </div>
      </fieldset>
    </form>
  </div>
</div>
{% endblock %}